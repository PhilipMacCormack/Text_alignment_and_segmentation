from Method_2.xml_word_coords import word_bb_coords
from Method_2.utils import get_iou

# path = '../../Data/Labours_Memory_Test_Data/'
# file = 'fac_00178_arsberattelse_1907_sid-01'
# align_dict = {'1907': [0, [2835, 3123, 119, 252], 5, [1318, 1623, 1079, 1180]], 'SV.': [0, [316, 476, 227, 271]], 'BLECK-': [0, [316, 476, 227, 271]], 'OCH': [0, [528, 1354, 213, 275]], 'PLÅTSLAGAREFÖRBUNDETS': [0, [528, 1354, 213, 275]], 'AFDELNING': [1, [708, 735, 307, 342]], '11': [1, [890, 1079, 307, 342], 4, [1082, 1798, 941, 1088]], 'UPPSALA': [1, [890, 1079, 307, 342], 4, [1082, 1798, 941, 1088]], 'Uppsala': [1, [1968, 2232, 300, 405]], 'den': [1, [2279, 2388, 305, 369]], '190': [1, [2279, 2388, 305, 369]], 'Öfver': [3, [120, 557, 747, 941]], 'Svenska': [3, [645, 1269, 768, 890]], 'Bleck': [3, [1336, 1767, 747, 885]], 'o': [3, [1824, 1948, 772, 871], 6, [3031, 3173, 1335, 1427]], 'Plåtslagareförbundets': [3, [1982, 3430, 752, 941]], 'afd.': [4, [263, 565, 936, 1070]], 'no': [4, [877, 1021, 961, 1088]], 'Uppsalas': [4, [1082, 1798, 941, 1088]], 'verksamhet': [4, [1852, 3310, 931, 1023], 10, [1892, 2370, 1880, 1996], 12, [1133, 1672, 2132, 2293], 18, [1526, 3415, 2996, 3179], 23, [1957, 2401, 3682, 3871], 25, [637, 1061, 3985, 4092]], 'under': [4, [1852, 3310, 931, 1023], 10, [1892, 2370, 1880, 1996], 12, [1133, 1672, 2132, 2293], 18, [1526, 3415, 2996, 3179], 23, [1957, 2401, 3682, 3871], 25, [637, 1061, 3985, 4092]], 'år': [5, [813, 977, 1079, 1165]], 'Under': [6, [99, 582, 1328, 1452]], 'året': [6, [651, 990, 1317, 1450], 10, [2406, 3322, 1866, 2054], 18, [1526, 3415, 2996, 3179], 23, [2457, 3250, 3682, 3871], 25, [1138, 1447, 3973, 4090]], 'ha': [6, [1051, 1324, 1328, 1448]], 'afhållits': [6, [1416, 2056, 1337, 1452]], '18': [6, [2222, 2304, 1362, 1434]], 'ordinarie': [6, [2337, 2977, 1326, 1436]], '4': [7, [291, 723, 1489, 1633]], 'extra': [7, [291, 723, 1489, 1633]], 'prottokollförda': [7, [722, 2125, 1455, 1640]], 'möten': [7, [2170, 2794, 1455, 1640]], 'i': [8, [198, 332, 1619, 1722], 17, [1308, 1936, 2865, 3031], 24, [2434, 2971, 3790, 3974], 26, [142, 265, 4143, 4232]], 'medeltal': [8, [365, 1218, 1596, 1778]], 'besökta': [8, [1251, 1970, 1596, 1727]], 'af': [8, [2049, 2233, 1632, 1767], 8, [2576, 2779, 1608, 1760], 16, [2779, 2970, 2705, 2882]], '2/3': [8, [2268, 2488, 1615, 1778]], 'medlems-': [8, [2774, 3356, 1601, 1710]], 'I': [10, [233, 445, 1869, 2051]], 'afdelningen': [10, [451, 1427, 1879, 2054]], 'har': [10, [1495, 1820, 1864, 2054], 18, [1184, 1461, 3002, 3179], 23, [1116, 1392, 3693, 3807]], 'varit': [10, [2406, 3322, 1866, 2054]], 'inskrifna': [11, [226, 982, 1992, 2180]], 'femtiofem': [11, [1052, 1895, 1992, 2178]], '(5': [11, [2022, 2320, 2051, 2180]], '': [11, [2356, 3044, 1992, 2180]], 'Högsta': [11, [2356, 3044, 1992, 2180]], 'antalet': [12, [176, 1130, 2132, 2293]], 'var': [12, [1133, 1672, 2132, 2293]], 'augusti': [12, [1792, 3044, 2132, 2293]], 'mån': [12, [1792, 3044, 2132, 2293]], 'då': [12, [1792, 3044, 2132, 2293]], 'det': [12, [3082, 3400, 2145, 2257]], 'utgorde': [14, [336, 858, 2372, 2550]], 'Femtioen': [14, [881, 2775, 2372, 2550], 24, [1533, 2296, 3790, 3974]], '(51': [14, [881, 2775, 2372, 2550], 24, [1533, 2296, 3790, 3974]], 'medlemmar.': [13, [168, 3272, 2236, 2433]], 'Vid': [14, [336, 858, 2372, 2550]], 'årets': [14, [881, 2775, 2372, 2550], 24, [1533, 2296, 3790, 3974]], 'slut': [14, [881, 2775, 2372, 2550], 24, [1533, 2296, 3790, 3974]], 'kvarstår': [14, [881, 2775, 2372, 2550], 24, [1533, 2296, 3790, 3974]], '40': [14, [881, 2775, 2372, 2550], 24, [1533, 2296, 3790, 3974]], 'st.': [14, [881, 2775, 2372, 2550], 24, [1533, 2296, 3790, 3974]], 'godkända': [15, [146, 1004, 2584, 2762]], 'medlemmar': [15, [1050, 2000, 2585, 2762]], 'hvilken': [15, [2065, 2671, 2549, 2762]], 'siffra': [15, [2739, 3233, 2570, 2762]], 'för': [16, [155, 469, 2705, 2882]], 'närvarande': [16, [532, 1434, 2721, 2882]], 'med': [16, [1481, 1859, 2733, 2820]], 'undantag': [16, [1848, 2747, 2725, 2882]], 'en': [16, [2978, 3396, 2738, 2842]], '(1)': [16, [2978, 3396, 2738, 2842]], 'Omfattar': [17, [158, 868, 2845, 3031]], 'alla': [17, [953, 1279, 2869, 2973]], 'staden': [17, [1308, 1936, 2865, 3031]], 'arbetande': [17, [2003, 3379, 2845, 3031]], 'koleger': [17, [2003, 3379, 2845, 3031]], 'Afdelningen': [18, [98, 1128, 2996, 3179], 23, [123, 1060, 3682, 3871]], 'genomfört': [18, [1526, 3415, 2996, 3179]], 'ett': [19, [120, 3185, 3072, 3304]], 'nytt': [19, [120, 3185, 3072, 3304]], 'arbetsaftal': [19, [120, 3185, 3072, 3304]], 'Hvilken': [19, [120, 3185, 3072, 3304]], 'genom': [19, [120, 3185, 3072, 3304]], 'ömsesidigt': [20, [148, 1001, 3249, 3454]], 'tillmötesgående': [20, [1027, 2313, 3249, 3454]], 'och': [20, [2402, 2678, 3249, 3376]], 'tack': [20, [2635, 3377, 3275, 3454]], 'vare': [20, [2635, 3377, 3275, 3454]], 'vår': [21, [171, 473, 3427, 3596]], 'Förtroendemans': [21, [509, 2723, 3390, 3596]], 'ingripande': [21, [509, 2723, 3390, 3596]], 'utföll': [21, [2792, 3279, 3414, 3566]], 'till': [22, [153, 473, 3567, 3674]], 'båda': [22, [480, 895, 3564, 3721]], 'parters': [22, [908, 1628, 3575, 3721]], 'belåtenhet': [22, [1668, 2611, 3531, 3721]], 'vidare': [23, [1433, 1890, 3707, 3871]], 'beslutat': [23, [2457, 3250, 3682, 3871]], 'å': [24, [173, 1491, 3790, 3974]], 'inlösa': [24, [173, 1491, 3790, 3974]], 'tio': [24, [173, 1491, 3790, 3974]], '(10)': [24, [173, 1491, 3790, 3974]], 'andelar': [24, [1533, 2296, 3790, 3974], 25, [2579, 3136, 3961, 4120]], 'folkets': [24, [2434, 2971, 3790, 3974]], 'hus': [24, [2996, 3342, 3823, 3927]], 'Samt': [25, [163, 634, 3967, 4103]], 'inlöst': [25, [1499, 1966, 3961, 4120]], 'fem': [25, [1959, 2497, 3961, 4114]], '(5)': [25, [1959, 2497, 3961, 4114]], 'uppsala': [26, [296, 974, 4145, 4275]], 'arbetares': [26, [1046, 1669, 4127, 4233]], 'konsumsionsförening': [26, [1733, 2766, 4103, 4218]]}
# gt_coords = word_bb_coords(path,file)
# print('align_dict: ', align_dict)
# print('--------------------------------------------------')
# print('gt_coords: ',gt_coords)

def iou_metric(align_dict, gt_coords):
    no_of_lines = max(align_dict.values())[0]
    align_list = []
    for i in range(1, no_of_lines+1):
        for key,val in align_dict.items():
            if len(val) > 2:
                no_val = int(len(val))
                for j in range(no_val):
                    if val[j] == i:
                        align_list.append([key,val[j+1]])
            else:
                if val[0] == i:
                    align_list.append([key, val[1]])
    # print('align_list: ', align_list)


    IOUS = []
    # print('align list length: ',len(align_list))
    lenn = 0
    for word in align_list:
        for gt_word in gt_coords:
            if word[0] == gt_word[0]:
                bb1 = word[1]
                bb2 = gt_word[1:len(gt_word)]
                # print(word[0],' bb1: ', bb1)
                # print(gt_word[0],' bb2: ', bb2)
                iou = get_iou(bb1, bb2)
                lenn += 1
                # print(word[0],' iou=', iou)
                IOUS.append(iou)
                gt_coords.remove(gt_word)
                break
            # else:
                # print('word: ', word[0])
                # print('gt_word: ', gt_word[0])
    # print('lenn: ',lenn)
    # print('ious:', IOUS)
    return sum(IOUS)/len(IOUS)

# print(iou_metric(align_dict, gt_coords))